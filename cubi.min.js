Utils={merge:function(e,t){var n={},r=null;for(r in e)n[r]=e[r];for(r in t)n[r]=t[r];return n},addObserverMethods:function(e){e.listeners={},e.on=function(t,n){e.listeners[t]=e.listeners[t]||[],e.listeners[t].push(n)},e.off=function(t,n){e.listeners[t]=e.listeners[t].filter(function(e){return e!=n})},e.fire=function(t,n){n=n||[],n=Array.isArray(n)?n:[n],(e.listeners[t]||[]).forEach(function(t){t.apply(e,n)})}},interpolate:function(e,t){for(var n in t)e=e.replace(new RegExp("%{"+n+"}","g"),t[n]);return e}},NodeList.prototype.forEach=Array.prototype.forEach,function(){Grid=function(e,t,n){this.rows=e,this.cols=t,this.canvas=n,this.container=document.createElement("table"),this.path=[],this.cells=[]},Grid.prototype.render=function(){e.call(this),this.path=t.call(this),this.path.forEach(function(e){e.setType(GridCell.PATH)})};var e=function(){var e=this;for(var t=0;t<this.rows;t++){var n=document.createElement("tr"),r=[];for(var i=0;i<this.cols;i++){var s=new GridCell(e);r.push(s),n.appendChild(s.getElement())}this.container.appendChild(n),this.cells.push(r)}this.canvas.appendChild(this.container)},t=function(){var e=n.call(this),t=[],i=this;return e.forEach(function(e,n){e.forEach(function(e){var s=r.call(i,n,e);t.push(s)})}),t},n=function(){var e=[],t=null;for(var n=0;n<this.cols;n++){var r=[],i=t!==null?t:~~(Math.random()*this.rows),s=~~(Math.random()*this.rows);if(n%2===0)r.push(i),t=i;else{if(i===s)r.push(i);else{for(var o=i;o!==s;i>s?o--:o++)r.push(o);r.push(o)}t=s}e.push(r)}return e},r=function(e,t){var n=this.container.querySelectorAll("tr"),r=n[t];return r.querySelectorAll("td")[e].cell}}(),function(){GridCell=function(e,t){var n=this;this.grid=e,this.type=GridCell.INACCESSABLE,this.dom=document.createElement("td"),this.dom.cell=this,this.dom.onclick=function(){n.fire("click")},this.setType(this.type),Utils.addObserverMethods(this)},GridCell.INACCESSABLE="inaccessable",GridCell.ACCESSABLE="accessable",GridCell.PATH="path",GridCell.MONSTER="monster",GridCell.TOWER="tower",GridCell.prototype.getElement=function(){return this.dom},GridCell.prototype.setType=function(e,t){this.type=e,this.dom.className=[this.type].concat(t||[]).join(" ")},GridCell.prototype.addClassName=function(e){this.dom.className=this.dom.className.split(" ").concat([e]).join(" ")},GridCell.prototype.removeClassName=function(e){this.dom.className=this.dom.className.split(" ").filter(function(t){return e!==t}).join(" ")},GridCell.prototype.hasClassName=function(e){return this.dom.className.split(" ").indexOf(e)!==-1},GridCell.prototype.getCoordinates=function(){var e=this.coordinates,t=this;return e||this.grid.cells.forEach(function(n,r){n.forEach(function(n,i){t===n&&(e=this.coordinates={x:r,y:i})})}),e}}(),function(){Monster=function(e,t){this.options=Utils.merge({speed:100,health:10,revenue:100},t||{}),this.path=e,this.pathIndex=0,this.cell=null,this.intervalId=null,Utils.addObserverMethods(this)},Monster.prototype.initMoving=function(){var t=this;this.intervalId=setInterval(function(){t.pathIndex<t.path.length?t.move():(e.call(t,null),t.fire("goal:reached"),clearInterval(t.intervalId))},this.options.speed)},Monster.prototype.stop=function(){clearInterval(this.intervalId)},Monster.prototype.move=function(){e.call(this,this.path[this.pathIndex]),this.pathIndex++,this.cell&&this.fire("move")},Monster.prototype.getPosition=function(){return this.cell&&this.cell.getCoordinates()},Monster.prototype.hurt=function(e){this.options.health-=e,this.options.health<=0&&this.die()},Monster.prototype.die=function(){this.stop(),this.cell.setType(GridCell.PATH),this.fire("die")};var e=function(e){this.cell&&this.cell.setType(GridCell.PATH),e&&e.setType(GridCell.MONSTER),this.cell=e}}(),function(){"use strict";var e=function(e,t){this.life=20,this.cash=1e3,this.dom=t,this.canvas=document.querySelectorAll(e)[0],window.Utils.addObserverMethods(this)};e.prototype.isDead=function(){return this.life===0},e.prototype.render=function(){this.dom.parentNode===null&&this.canvas.appendChild(this.dom),t.call(this),n.call(this)},e.prototype.canBuy=function(e,t){return t=typeof t=="undefined"?0:t,this.cash>=window.Tower.TYPES[e].costs[t]},e.prototype.buy=function(e,t){t=typeof t=="undefined"?0:t;var n=window.Tower.TYPES[e].costs[t];this.cash-=n,this.render()},e.prototype.earn=function(e){this.cash+=e,this.render()},e.prototype.sell=function(e){this.earn(e.getPrice()/2)},e.prototype.hurt=function(){this.life--,this.render(),this.life===0&&this.fire("died")},e.prototype.heal=function(){this.life++,this.render()};var t=function(){var e=document.getElementById("life");e||(e=document.createElement("span"),e.id="life",this.dom.appendChild(e)),e.innerHTML="HP: "+this.life.toString()+" / 20"},n=function(){var e=document.getElementById("cash");e||(e=document.createElement("span"),e.id="cash",this.dom.appendChild(e)),e.innerHTML="Cash: "+this.cash};window.Player=e}(),function(){Tower=function(e,t){this.type=e,this.level=0,this.cell=t,this.lastShot=null,this.range=null,Utils.addObserverMethods(this)},Tower.TYPES={LASER:{name:"Laser Tower",costs:[100,200,1e3],damages:[2,5,10],ranges:[3,5,7],frequencies:[500,450,400]},ROCKET:{name:"Rocket Tower",costs:[300,500,1500],damages:[10,15,25],ranges:[7,9,12],frequencies:[3e3,2700,2200]},FREEZER:{name:"Freezer",costs:[200,500,750],damages:[5,7,9],ranges:[3,4,5],frequencies:[5e3,4e3,3e3]}},Tower.prototype.upgrade=function(){this.level++,this.cell.setType(GridCell.TOWER,t.call(this))},Tower.prototype.render=function(){return this.cell.setType(GridCell.TOWER,t.call(this)),this},Tower.prototype.getPrice=function(){return Tower.TYPES[this.type].costs[this.level]},Tower.prototype.getRange=function(){return Tower.TYPES[this.type].ranges[this.level]},Tower.prototype.getFrequency=function(){return Tower.TYPES[this.type].frequencies[this.level]},Tower.prototype.getDamage=function(){return Tower.TYPES[this.type].damages[this.level]},Tower.prototype.checkDistanceTo=function(e){if(e.cell.dom){var t=this.pointIsInRange({x:e.cell.dom.offsetLeft+e.cell.dom.offsetWidth/2,y:e.cell.dom.offsetTop+e.cell.dom.offsetHeight/2});t&&this.canShoot()&&(this.shoot(e),this.lastShot=+(new Date))}},Tower.prototype.pointIsInRange=function(t){var n=this.getRange()*this.cell.dom.offsetHeight,r=e.call(this).x,i=e.call(this).y,s=Math.pow(Math.pow(t.x-r,2)+Math.pow(t.y-i,2),.5);return s<=n},Tower.prototype.canShoot=function(){return!this.lastShot||+(new Date)-this.lastShot>=this.getFrequency()},Tower.prototype.shoot=function(e){var t=document.createElement("div"),n=document.body,r=e.cell.dom.offsetLeft,i=e.cell.dom.offsetTop,s=this;t.className="bullet",t.style.left=this.cell.dom.offsetLeft+this.cell.dom.offsetWidth/2+"px",t.style.top=this.cell.dom.offsetTop+this.cell.dom.offsetHeight/2+"px",n.appendChild(t),setTimeout(function(){t.style.left=e.cell.dom.offsetLeft+e.cell.dom.offsetWidth/2+"px",t.style.top=e.cell.dom.offsetTop+e.cell.dom.offsetHeight/2+"px"}.bind(this),10),setTimeout(function(){n.removeChild(t),e.hurt(this.getDamage())}.bind(this),250)},Tower.prototype.renderRange=function(){var t=document.createElement("div"),n=this.cell.dom,r=n.offsetHeight,i=this;t.className="range",t.style.width=t.style.height=this.getRange()*2*n.offsetHeight+"px";var s=e.call(this).x-parseInt(t.style.width,10)/2-2,o=e.call(this).y-parseInt(t.style.height,10)/2-2;t.style.left=s+"px",t.style.top=o+"px",this.range=t,this.range.onclick=function(){i.removeRange(),document.querySelectorAll(".menu").forEach(function(e){document.body.removeChild(e)})},document.body.appendChild(t)},Tower.prototype.removeRange=function(){var e=document.body;this.range&&e.removeChild(this.range),this.range=null},Tower.prototype.destroy=function(){t.call(this).forEach(function(e){this.cell.removeClassName(e)}.bind(this))};var e=function(){return{x:this.cell.dom.offsetLeft+this.cell.dom.offsetWidth/2,y:this.cell.dom.offsetTop+this.cell.dom.offsetHeight/2}},t=function(){var e=this.type.toLowerCase().replace(/ /,"-"),t="level-"+this.level;return[e,t]}}(),function(){TowerMenu=function(e){this.cell=e,Utils.addObserverMethods(this)},TowerMenu.prototype.render=function(){var t=this,n=document.getElementById("tower-menu");return this.cell.addClassName("selected"),n||(n=e.call(this),document.body.appendChild(n)),this},TowerMenu.prototype.remove=function(){var e=document.getElementById("tower-menu"),t=document.body;this.cell.removeClassName("selected"),t.removeChild(e)};var e=function(){var e=document.createElement("ul");e.id="tower-menu",e.className="menu";for(var n in Tower.TYPES)t.call(this,n,e);return e},t=function(e,t){var n=this,r=document.createElement("li"),i=Tower.TYPES[e],s=Utils.interpolate("%{name} (%{costs})",{name:i.name,costs:i.costs[0]}),o=document.createTextNode(s);r.appendChild(o),r.setAttribute("data-tower-type",e),r.className=e.toLowerCase(),r.onclick=function(){n.fire("select",this.getAttribute("data-tower-type"))},t.appendChild(r)}}(),function(){"use strict";var e=function(e,t){this.tower=e,this.player=t,this.dom=document.createElement("ul"),Utils.addObserverMethods(this)};e.prototype.render=function(){this.dom.className="menu",t.call(this),n.call(this),document.body.appendChild(this.dom)},e.prototype.clear=function(){document.body.removeChild(this.dom)};var t=function(){var t=document.createElement("li"),n=this.tower.level+1,r=window.Tower.TYPES[this.tower.type].costs[n],i="Upgrade to Level %{level} (%{costs})";n===3?(i="Max level %{level} reached.",i=window.Utils.interpolate(i,{level:n,costs:r})):t.onclick=function(){this.player.canBuy(this.tower.type,n)?(this.player.buy(this.tower.type,n),this.tower.upgrade(),this.tower.removeRange(),this.tower.renderRange(),this.clear(),(new e(this.tower,this.player)).render()):alert("too expensive!"),i=window.Utils.interpolate(i,{level:n+1,costs:r})}.bind(this),t.appendChild(document.createTextNode(window.Utils.interpolate(i,{level:n+1,costs:r}))),t.className="upgrade",this.dom.appendChild(t)},n=function(){var e=document.createElement("li"),t=this.tower.level,n=window.Tower.TYPES[this.tower.type].costs[t]/2,r=window.Utils.interpolate("Sell (%{costs})",{costs:n});e.appendChild(document.createTextNode(r)),e.onclick=function(){this.player.sell(this.tower),this.tower.destroy(),this.fire("tower:sold",this.tower)}.bind(this),e.className="sell",this.dom.appendChild(e)};window.TowerMetaMenu=e}(),function(){Game=function(e,t){this.options=Utils.merge({rows:10,cols:10,waveDuration:2e4},t||{}),this.canvas=document.querySelector(e),this.grid=new Grid(this.options.rows,this.options.cols,this.canvas),this.meta=document.createElement("div"),this.player=new Player(e,this.meta),this.player.on("died",function(){alert("Hmm... there you go :("),this.pause()}.bind(this)),this.monsters=[],this.towers=[],this.wave=-1,this.nextWaveStartsAt=null,this.towerMenu=null},Game.prototype.render=function(n){return this.grid.render(),this.player.render(),this.meta.id="meta-data",document.body.appendChild(this.meta),e.call(this,this.spawnNextWave.bind(this)),t.call(this),setInterval(t.bind(this),1e3),r.call(this),this},Game.prototype.pause=function(){this.monsters.forEach(function(e){e.forEach(function(e){e.stop()})})},Game.prototype.continue=function(){this.monsters.forEach(function(e){e.forEach(function(e){e.initMoving()})})},Game.prototype.getTowerByGridCell=function(e){var t=this.towers.filter(function(t){return t.cell===e});return t.length===1?t[0]:null},Game.prototype.spawnNextWave=function(){this.wave++,this.monsters[this.wave]=n.call(this),a.call(this)};var e=function(t){this.nextWaveStartsAt=this.nextWaveStartsAt||+(new Date)+5e3,setTimeout(function(){this.player.isDead()||(t(),this.nextWaveStartsAt=+(new Date)+this.options.waveDuration,e.call(this,t))}.bind(this),Math.abs(+(new Date)-this.nextWaveStartsAt))},t=function(){var e=document.getElementById("wave-duration");e||(e=document.createElement("span"),e.id="wave-duration",this.meta.appendChild(e));var t=Math.ceil(Math.abs(+(new Date)-this.nextWaveStartsAt)/1e3),n="Wave #"+(this.wave+2)+" starts in "+t+"s";e.innerHTML=n},n=function(){var e=this,t=Math.max(250,~~(Math.random()*1e3)),n=[];for(var r=0;r<(this.wave+1)*10;r++){var i=new Monster(this.grid.path,{speed:t,health:(this.wave+1)*10});i.on("goal:reached",this.player.hurt.bind(this.player)),i.on("move",function(){u.call(e,this)}),i.on("die",function(){e.monsters=e.monsters.filter(function(e){return e!==i}),e.player.earn(i.options.revenue)}),n.push(i)}return n},r=function(){var e=this;this.grid.cells.forEach(function(t){t.forEach(function(t){t.on("click",function(){switch(this.type){case GridCell.INACCESSABLE:o.call(e,this),i.call(e);break;case GridCell.TOWER:i.call(e),e.menu&&(e.menu.remove(),e.menu=null);var t=e.getTowerByGridCell(this),n=new TowerMetaMenu(t,e.player);t.renderRange(),n.render(),n.on("tower:sold",function(t){i.call(e),e.towers=e.towers.filter(function(e){return e!==t}),s.call(this)})}})})})},i=function(){this.towers.forEach(function(e){e.removeRange()})},s=function(){this.menu&&this.menu.remove(),document.querySelectorAll(".menu").forEach(function(e){document.body.removeChild(e)})},o=function(e){var t=this;s.call(this);if(e.hasClassName("tower"))return;this.menu=(new TowerMenu(e)).render(),this.menu.on("select",function(n){if(t.player.canBuy(n)){var r=(new Tower(n,e)).render();t.player.buy(n),t.towers.push(r),e.fire("click")}else alert("too expensive!")})},u=function(e){this.towers.forEach(function(t){t.checkDistanceTo(e)})},a=function(){this.monsters[this.wave].forEach(function(e,t){setTimeout(function(){e.initMoving()},t*2*e.options.speed)})}}(),window.addEventListener("load",function(){var e=window,t=document,n=t.documentElement,r=t.getElementsByTagName("body")[0],i=e.innerWidth||n.clientWidth||r.clientWidth,s=e.innerHeight||n.clientHeight||r.clientHeight,o=24,u=28;game=(new Game("body",{cols:~~(i/o),rows:~~((s-30)/u)})).render()},!1);